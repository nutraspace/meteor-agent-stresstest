#!/bin/bash

# populate Drones
declare -a Drones=()
while read line; do Drones=("${Drones[@]}" "$line"); done < drones

# Starting Docker Cleanup!
for i in "${Drones[@]}"
do
   echo "#########Status of Docker Process on $i ##########"
   ssh $i "var=\$(systemctl -l status docker | grep Active); echo  \$var"
   printf "\n"
   echo "####################################################"
   printf "\n"   
   echo "      Show Docker mnt & Container info on $i"
   echo "####################################################"
   printf"\n"
   echo "Number of files in /var/lib/docker/devicemapper/mnt/ on $i"
   ssh $i "var=\$(ls  /var/lib/docker/devicemapper/mnt/ | wc -l); echo \$var"
   echo "Number of files in /var/lib/docker/containers/ on $i"
   ssh $i "var=\$(ls  /var/lib/docker/containers/ | wc -l); echo \$var"
   echo "#############"
   echo "Show how Dockerized Casper(s) stats running on $i"
   ssh $i "var=\$(docker stats `docker ps -qa`); echo \$var"
   echo "#############"
   ssh $i "var=\$(docker top `docker ps -qa`); echo \$var"
   echo "#############"
#docker stop `docker ps -qa`
#rmi
   echo " #########Cleaning up Docker on $i for Casperjs##########"
   printf "\n"
   echo "Stop Dockerized Casper(s) running on $i"
   ssh $i "var=\$(docker stop `docker ps -qa`); echo \$var"
   echo "#############"
   echo "Removing Dockerized Casper(s) running on $i"
   ssh $i "var=\$(docker rm `docker ps -qa`); echo \$var"
   printf "\n"
   echo "Stopping Docker running on $i"
   ssh $i "var=\$(systemctl -l stop docker && systemctl -l status docker | grep Active); echo  \$var"
   printf "\n"
   echo "####################################################"
   echo "   Cleaning up mnt & container directories on $i"
   echo "####################################################"
   printf "\n"
   ssh $i "var=\$(rm -fr  /var/lib/docker/devicemapper/mnt/*); echo \$var"
   ssh $i "var=\$(rm -fr  /var/lib/docker/containers/*); echo \$var"
   printf "\n"
   echo "####################################################"
   echo "   Cleaning up mnt & container directories on $i"
   echo "####################################################"
   echo "Number of files in /var/lib/docker/devicemapper/mnt/ on $i"
   ssh $i "var=\$(ls  /var/lib/docker/devicemapper/mnt/ | wc -l); echo \$var"
   echo "Number of files in /var/lib/docker/containers/ on $i"
   ssh $i "var=\$(ls  /var/lib/docker/containers | wc -l); echo \$var"
   echo "#############" 
   echo "Starting Docker on $i"
   ssh $i "=\$(systemctl -l start docker); echo  \$var | grep Active"
   printf "\n"
   echo "#############"
   printf "\n"
   echo " #########Starting Processes########## $i"
   ssh $i "var=\$(systemctl start docker && systemctl restart docker && systemctl -l status docker | grep Active); echo  \$var"
   printf "\n"
done
